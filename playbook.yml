---
- hosts: all
  gather_facts: no
  tasks:
    - script: scripts/pacmankeygen.sh
    - raw: pacman -Sy --noconfirm --needed pacman
    - raw: pacman -S --noconfirm --needed python2 python2-pip
- hosts: all
  vars_prompt:
    - name: admin_pw
      prompt: User password
      private: yes
      confirm: yes
      encrypt: sha512_crypt
    - name: github_pw
      prompt: Github password
      private: yes
      confirm: yes
  vars_files:
    - resources/common.yml
    - resources/packages.yml
    - resources/pacnews.yml
    - resources/ips.yml
    - resources/repos.yml
  tasks:
    - pip: name=$item state=latest pip=pip2
      with_items: ${modules.python2}
    - copy: src=files/mirrorlist dest=/etc/pacman.d/mirrorlist
    - copy: src=files/pacman.conf dest=/etc/pacman.conf
    - pacman: update=yes
    - pacman: name=$item
      with_items: ${packages.add}
    - pacman: name=$item state=absent
      with_items: ${packages.remove}
    - pacnew: path=${item.path} new=${item.new} old=${item.old} keep=${item.keep}
      with_items: ${pacnews}
    - pacnew: check_all=yes
    - file: state=absent path=$item
      with_items: ${files.toremove}
    - pip: name=$item state=latest pip=pip3
      with_items: ${modules.python3}
    - raw: systemctl --system daemon-reload
    
    - template: src=files/hostname.j2 dest=/etc/hostname
    - template: src=files/hosts.j2 dest=/etc/hosts
    - template: src=files/netcfg.j2 dest=/etc/network.d/main
    - lineinfile: dest=/etc/conf.d/netcfg regexp=^NETWORKS line=NETWORKS=(main)
    - raw: 'systemctl stop dhcpcd@eth0 ; systemctl start netcfg ; systemctl start netcfg'
    - copy: src=files/resolv.conf dest=/etc/resolv.conf
    - copy: src=files/iptables dest=/etc/iptables/iptables.rules
    - copy: src=files/ip6tables dest=/etc/iptables/ip6tables.rules
    
    - lineinfile: >
        dest=/etc/mail/exim.conf 
        regexp='^[ #]*primary_hostname =' 
        line='primary_hostname = ${inventory_hostname}.${domain}'
    - lineinfile: >
        dest=/etc/mail/exim.conf 
        insertafter='^[ #]*primary_hostname ='
        regexp='^local_interfaces ='
        line='local_interfaces = 127.0.0.1'
    - lineinfile: >
        dest=/etc/mail/exim.conf 
        regexp='^domainlist local_domains =' 
        line="domainlist local_domains = localhost : localhost.localdomain : ${inventory_hostname} : ${inventory_hostname}.${domain}"
    - lineinfile: >
        dest=/etc/mail/aliases 
        regexp='^[\s#]*root:' 
        line='root: admin@${domain}'
        
    - command: timedatectl set-timezone US/Eastern
    - lineinfile: dest=/etc/locale.gen line='en_US.UTF-8 UTF-8' regexp='#?en_US.UTF-8 UTF-8'
    - lineinfile: dest=/etc/locale.gen line='en_US ISO-8859-1' regexp='#?en_US ISO-8859-1'
    - command: locale-gen
    
    - command: swapon --show=NAME --noheadings
      register: swapdev
    - command: awk '/ext/ { print $1 }' /etc/fstab
      register: rootdev
    - template: src=files/fstab.j2 dest=/etc/fstab
    
    - user: name=ftp state=absent remove=yes force=yes
    - lineinfile: dest=/etc/shadow regexp='^dbus' line='dbus:x:14871::::::'
    - lineinfile: dest=/etc/shadow regexp='^uuidd' line='uuidd:x:14871::::::'
    - group: name=remote
    - user: >
        name=root 
        generate_ssh_key=yes 
        ssh_key_bits=8096 
        ssh_key_comment=root@${inventory_hostname}
        shell=/bin/zsh
    - user: >
        name=${admin_user}
        password=${admin_pw}
        generate_ssh_key=yes
        ssh_key_bits=8096
        ssh_key_comment=${admin_user}@${inventory_hostname}
        groups='wheel,remote'
        shell=/bin/zsh
    
    - github: username=${github_user} password=${github_pw}
    - raw: 'ssh git@github.com -o StrictHostKeyChecking=no || true'
    - git: dest=${item.path} repo=${item.repo}
      with_items: ${repos}
    
    - copy: src=files/dotdotdot.conf dest='/opt/dotdotdot/conf'
    - file: state=link path='/root/...' src=/opt/dotdotdot
    - file: state=link path='/home/${admin_user}/...' src=/opt/dotdotdot
    - command: /opt/dotdotdot/... install creates=/root/.zshrc
    - command: su ${admin_user} -c '/opt/dotdotdot/... install' creates=/home/${admin_user}/.zshrc
    
    - file: path=/opt/packer/packer mode=0755
    - file: state=link path=/usr/local/bin/packer src=/opt/packer/packer
    
    - copy: src=files/sshd_config dest=/etc/ssh/sshd_config
    - file: state=directory path=/home/${admin_user}/.ssh owner=${admin_user} group=users mode=0700
    - assemble: src=/opt/keys dest=/home/${admin_user}/.ssh/authorized_keys owner=${admin_user} group=users mode=600

    - command: make install chdir=/opt/google-authenticator creates=/lib/security/pam_google_authenticator.so
    - tokengen: length=16 keyspace=base32
      register: twofa
    - template: src=files/2fa.j2 dest=/root/.2fa mode=0600
    - lineinfile: >
        dest=/etc/pam.d/su
        regexp='auth\s*required\s*pam_wheel.so\s*use_uid'
        line='auth required pam_wheel.so use_uid'
    - lineinfile: >
        dest=/etc/pam.d/su-l
        regexp='auth\s*required\s*pam_wheel.so\s*use_uid'
        line='auth required pam_wheel.so use_uid'
    - lineinfile: >
        dest=/etc/pam.d/su
        insertafter='auth\s*required\s*pam_unix.so'
        regexp='auth required pam_google_authenticator.so secret=~/.2fa'
        line='auth required pam_google_authenticator.so secret=~/.2fa'
    - lineinfile: >
        dest=/etc/pam.d/su-l
        insertafter='auth\s*required\s*pam_unix.so'
        regexp='auth required pam_google_authenticator.so secret=~/.2fa'
        line='auth required pam_google_authenticator.so secret=~/.2fa'
    - lineinfile: >
        dest=/etc/pam.d/system-auth
        insertafter='auth\s*required\s*pam_unix.so'
        regexp='auth required pam_google_authenticator.so secret=~/.2fa'
        line='auth required pam_google_authenticator.so secret=~/.2fa'

    - command: /usr/local/bin/packer -S fwknop --noconfirm creates=/usr/bin/fwknop
    - shell: /usr/local/bin/packer -S gnupg1 --noconfirm > /dev/null creates=/usr/bin/gpg1
    - file: state=link path=/usr/bin/gpg src=/usr/bin/gpg1
    - command: haveged
    - gpgkey: >
        length=2048
        expiry=0
        name='Les Aker' 
        comment=${inventory_hostname} 
        email=admin@${inventory_hostname}.${domain}
        replaceOld=yes
      register: newKey
    - signkey: ${adminKeyID} ${newKey.passphrase}
    - template: src=files/fwknop.j2 dest=/etc/fwknop/access.conf
    - lineinfile: >
        dest=/etc/fwknop/fwknopd.conf
        regexp='#*PCAP_FILTER\s*udp\s*port\s*\d+\s*;'
        line='PCAP_FILTER udp port 465;'
    
    - service: name=dhcpcd@eth0.service action=stop enabled=no
    - service: name=netcfg.service enabled=yes
    - service: name=iptables enabled=yes
    - service: name=ip6tables enabled=yes
    - service: name=haveged.service action=start enabled=yes
    - service: name=syslog-ng.service action=start enabled=yes
    - service: name=cronie.service action=start enabled=yes
    - service: name=remote-fs.target action=stop enabled=no
    - service: name=exim.service action=start enabled=yes
    - service: name=fwknopd.service action=restart enabled=yes
    - service: name=getty@tty1.service enabled=no
    
    - shell: cat /sys/hypervisor/type 2>/dev/null || true
      register: xencheck
    - group_by: key=${xencheck.stdout}
    - group_by: key=${ansible_virtualization_type}
    
- hosts: kvm
  tasks:
    - shell: /usr/local/bin/packer -S grub-legacy --noconfirm > /dev/null creates=/sbin/grub
    - command: 'cp /usr/lib/grub/i386-pc/* /boot/grub/'
    - template: src=files/grub.j2 dest=/root/grubcmd
    - shell: cat /root/grubcmd | grub --no-curses
    - file: state=absent path=/root/grubcmd

- hosts: xen
#  vars_prompt:
#      - name: linode_pw
#        prompt: Linode password
#        private: yes
#        confirm: yes
  tasks:
#      - local_action: linodeapi 
    - pause: prompt="Switch ${inventory_hostname} to use PV-GRUB and disable helpers"


## Task specific configs go here

- hosts: all
  vars_prompt:
    - name: root_pw
      prompt: Root password
      private: yes
      confirm: yes
      encrypt: sha512_crypt
  vars_files:
    - resources/common.yml
  tasks:
    - file: state=absent path=/boot/grub/menu.lst
    - command: /opt/roller/autoroll.py

    - pause: prompt="All remote configuration completed. Press enter for local actions"

    - local_action: >
        command open
        'https://www.google.com/chart?chs=300x250&chld=M|0&cht=qr&chl=otpauth://totp/${inventory_hostname}?secret=${twofa.token}'
    - command: gpg -a --output /gpg.pub --yes --export ${newKey.keyid}
    - fetch: src=/gpg.pub dest=feedback
    - file: path=/gpg.pub state=absent
    - local_action: shell while gpg --yes --no-tty --batch --delete-key admin@${inventory_hostname}.${domain} ; do echo -n ; done
      ignore_errors: yes
    - local_action: command gpg --import feedback/${inventory_hostname}/gpg.pub
      ignore_errors: yes 

    - pause: prompt="Press enter to set root password and reboot server(s), or Ctrl-C A to stop playbook"
    - command: shutdown
    - user: name=root password=${root_pw}
...

